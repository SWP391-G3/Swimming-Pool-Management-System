<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chi tiết bể bơi</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
            />
        <link rel="stylesheet" href="css/styles.css" />
        <style>
            @media (max-width: 768px) {
                .sticky-pay-btn {
                    position: fixed !important;
                    bottom: 0;
                    left: 0;
                    width: 100vw;
                    z-index: 50;
                    border-radius: 0 !important;
                }
                .balance-grid {
                    display: flex !important;
                    flex-direction: column !important;
                }
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #e5e7eb;
                border-radius: 8px;
            }
            .calendar-day.selected {
                background: #2563eb;
                color: #fff !important;
                border-radius: 50%;
            }
            .calendar-day.today {
                border: 2px solid #2563eb;
                border-radius: 50%;
            }
            .calendar-day:hover {
                background: #e0e7ff;
                color: #2563eb;
                cursor: pointer;
                border-radius: 50%;
            }
            .calendar-day.disabled {
                color: #d1d5db !important;
                pointer-events: none;
            }
            .slot-item.selected {
                border-color: #2563eb;
                background: #eff6ff;
            }
            .slot-item:hover {
                border-color: #2563eb;
                background: #f0f8ff;
            }
        </style>
    </head>
    <body class="bg-gray-50 min-h-screen font-['Inter'] antialiased">
        <div class="container mx-auto px-4 py-8 max-w-5xl">
            <!-- Header -->
            <div class="flex items-center mb-6">
                <a
                    href="booking_history"
                    class="mr-3 text-gray-700 hover:text-blue-600"
                    >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"
                        />
                    </svg>
                </a>
                <h1 class="text-xl md:text-2xl font-bold">Chi tiết bể bơi</h1>
            </div>

            <div
                class="grid grid-cols-1 md:grid-cols-[340px_1fr] gap-6 balance-grid items-start"
                >
                <!-- Cột trái -->
                <div class="flex flex-col gap-5 h-fit">
                    <!-- Box Thông tin bể bơi: chữ nhỏ lại, layout hợp lý hơn -->
                    <div
                        class="bg-white border border-gray-300 rounded-lg p-5 flex flex-col gap-2"
                        >
                        <div class="font-semibold text-base mb-2">Lựa chọn của bạn</div>
                        <div class="flex flex-row gap-4">
                            <!-- Hình ảnh -->
                            <div
                                class="w-24 h-24 bg-gray-100 rounded flex items-center justify-center shrink-0"
                                >
                                <img
                                    src="https://images.pexels.com/photos/261185/pexels-photo-261185.jpeg?auto=compress&fit=crop&w=96&q=80"
                                    alt="Hồ bơi"
                                    class="w-20 h-20 object-cover rounded"
                                    />
                            </div>
                            <!-- Thông tin tên, địa chỉ (chữ nhỏ lại, căn dòng đẹp) -->
                            <div class="flex flex-col justify-center flex-1">
                                <span class="font-semibold text-base leading-tight"
                                      >Hồ bơi mùa hè</span
                                >
                                <span
                                    class="flex items-center gap-2 mt-1 text-gray-500 text-sm"
                                    >
                                    Địa chỉ: 123 Đường Bơi, Quận 1, TP.HCM
                                </span>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 my-3"></div>
                        <!-- Slot + ngày giờ -->
                        <div class="flex gap-2">
                            <button
                                id="slotBtn"
                                class="flex flex-col items-center justify-center border border-gray-300 rounded-md px-5 py-2 min-w-[55px] focus:outline-none focus:ring-2 focus:ring-blue-400"
                                type="button"
                                >
                                <div class="text-xs text-gray-500">Slot</div>
                                <div
                                    class="text-base font-bold text-blue-700"
                                    id="slotNumberText"
                                    >
                                    2
                                </div>
                            </button>
                            <div
                                class="flex-1 flex flex-col justify-center border border-gray-300 rounded-md px-3 py-2"
                                >
                                <div class="flex items-center gap-2 mb-1">
                                    <svg
                                        class="w-4 h-4 text-blue-600"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                        >
                                    <path
                                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        />
                                    </svg>
                                    <span class="font-medium text-sm" id="selectedDateText"
                                          >18/06/2025</span
                                    >
                                </div>
                                <div class="flex items-center gap-2 text-gray-500 text-xs">
                                    <svg
                                        class="w-3 h-3 text-gray-400"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                        >
                                    <circle cx="12" cy="12" r="10" stroke-width="2" />
                                    <path
                                        d="M12 8v4l3 3"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        />
                                    </svg>
                                    <span id="selectedTimeText">16:00 - 18:00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Người đặt -->
                    <div
                        class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col gap-2"
                        >
                        <div class="font-bold text-lg mb-1">Người đặt</div>
                        <div class="flex justify-between text-gray-700 text-sm">
                            <span>Họ và tên</span>
                            <span class="font-semibold">Nguyễn Văn A</span>
                        </div>
                        <div class="flex justify-between text-gray-700 text-sm">
                            <span>Số điện thoại:</span>
                            <span class="font-semibold">0987654321</span>
                        </div>
                    </div>
                    <!-- Ưu đãi -->
                    <div
                        class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col gap-3"
                        >
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-base">Ưu đãi</span>
                            <span
                                id="chooseVoucherSpan"
                                class="ml-3 px-3 py-2 rounded-md bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold text-sm border border-blue-200 transition cursor-pointer select-none"
                                >Chọn ưu đãi</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Cột phải (thao tác booking) -->
                <div class="flex flex-col gap-5 h-full">
                    <!-- Đặt vé -->
                    <div
                        class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col gap-3"
                        >
                        <div class="font-bold text-lg mb-1">Đặt vé</div>
                        <!-- Danh sách vé đã chọn -->
                        <div id="selectedTicketsArea"></div>
                        <!-- Nút thêm vé -->
                        <button
                            id="addTicketBtn"
                            class="text-blue-600 hover:underline flex items-center gap-1 text-sm mb-1"
                            type="button"
                            >
                            <span>+ Thêm vé</span>
                        </button>
                        <div class="flex items-center gap-1 text-xs text-gray-400 mt-2">
                            <svg
                                class="w-3 h-3"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                >
                            <circle cx="12" cy="12" r="10" stroke-width="2" />
                            <path d="M8 12h4v4" stroke-width="2" stroke-linecap="round" />
                            </svg>
                            Chính sách hoàn tiền
                        </div>
                    </div>
                    <!-- Thuê đồ -->
                    <div
                        class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col gap-3"
                        >
                        <div class="font-bold text-lg mb-1">Thuê đồ</div>
                        <div id="selectedRentsArea"></div>
                        <button
                            id="addRentBtn"
                            class="text-blue-600 hover:underline flex items-center gap-1 text-sm mb-1"
                            type="button"
                            >
                            <span>+ Thêm đồ</span>
                        </button>
                    </div>
                    <!-- Chi tiết thanh toán + nút Thanh toán -->
                    <div
                        class="bg-white border border-gray-200 rounded-lg p-5 flex flex-col h-full"
                        >
                        <div class="font-bold text-lg mb-2">Chi tiết thanh toán</div>
                        <div id="paymentDetailArea"></div>
                        <button
                            class="w-full bg-blue-600 text-white text-lg font-semibold rounded-lg py-3 shadow hover:bg-blue-700 transition-colors mt-2 sticky-pay-btn"
                            >
                            Đến Trang Thanh Toán
                        </button>
                    </div>
                </div>
            </div>

            <!-- Popup chọn ngày và giờ cho Slot -->
            <div
                id="slotModal"
                class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center transition-all hidden"
                >
                <div
                    id="slotModalContent"
                    class="relative bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-4xl flex flex-col md:flex-row gap-8 animate-fade-in custom-scrollbar"
                    >
                    <!-- Calendar -->
                    <div class="w-full md:w-[480px] flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <button
                                id="prevMonthBtn"
                                class="p-2 rounded-full hover:bg-blue-50 transition"
                                >
                                <svg
                                    class="w-6 h-6 text-gray-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    >
                                <path
                                    d="M15 19l-7-7 7-7"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    />
                                </svg>
                            </button>
                            <div
                                class="font-semibold text-xl text-gray-700"
                                id="calendarMonthLabel"
                                ></div>
                            <button
                                id="nextMonthBtn"
                                class="p-2 rounded-full hover:bg-blue-50 transition"
                                >
                                <svg
                                    class="w-6 h-6 text-gray-600"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                    >
                                <path
                                    d="M9 5l7 7-7 7"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    />
                                </svg>
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-7 gap-y-1 text-center text-base font-semibold text-gray-400 mb-2"
                            >
                            <div>C</div>
                            <div>T</div>
                            <div>T</div>
                            <div>T</div>
                            <div>T</div>
                            <div>T</div>
                            <div>S</div>
                        </div>
                        <div
                            id="calendarGrid"
                            class="grid grid-cols-7 gap-[2px] text-center text-base"
                            ></div>
                    </div>
                    <!-- Slot list -->
                    <div
                        class="w-full md:w-[330px] flex flex-col border-t md:border-t-0 md:border-l border-gray-200 pt-6 md:pt-0 md:pl-8"
                        >
                        <div
                            class="font-semibold text-lg text-blue-700 mb-4"
                            id="slotDayLabel"
                            >
                            Thứ 5, 19/06/2025
                        </div>
                        <div
                            id="slotList"
                            class="flex flex-col gap-3 overflow-y-auto max-h-[460px] pr-1 custom-scrollbar"
                            >
                            <!-- Slot items sẽ render ở đây -->
                        </div>
                    </div>
                    <!-- Close -->
                    <button
                        id="closeSlotModal"
                        class="absolute top-4 right-4 px-4 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 text-base font-medium shadow transition"
                        >
                        Đóng
                    </button>
                </div>
            </div>
            <!-- Popup chọn vé -->
            <div
                id="ticketModal"
                class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center transition-all hidden"
                >
                <div
                    class="relative bg-white rounded-xl shadow-2xl w-full max-w-md p-6 flex flex-col gap-4 max-h-[90vh] overflow-y-auto"
                    >
                    <div class="font-bold text-lg mb-2">Chọn vé</div>
                    <div id="ticketListArea" class="flex flex-col gap-3"></div>
                    <button
                        id="closeTicketModal"
                        class="absolute top-3 right-3 px-3 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm font-medium shadow transition"
                        >
                        Đóng
                    </button>
                </div>
            </div>

            <!-- Popup chọn đồ thuê -->
            <div
                id="rentModal"
                class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center transition-all hidden"
                >
                <div
                    class="relative bg-white rounded-xl shadow-2xl w-full max-w-md p-6 flex flex-col gap-4 max-h-[90vh] overflow-y-auto"
                    >
                    <div class="font-bold text-lg mb-2">Chọn đồ thuê</div>
                    <div id="rentListArea" class="flex flex-col gap-3"></div>
                    <button
                        id="closeRentModal"
                        class="absolute top-3 right-3 px-3 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm font-medium shadow transition"
                        >
                        Đóng
                    </button>
                </div>
            </div>

            <!-- Popup chọn voucher -->
            <div
                id="voucherModal"
                class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center transition-all hidden"
                >
                <div
                    class="relative bg-white rounded-xl shadow-2xl w-full max-w-[900px] p-6 flex flex-col gap-4 max-h-[95vh] overflow-y-auto"
                    >
                    <div class="font-bold text-xl mb-3">Danh sách voucher</div>
                    <div
                        id="voucherListArea"
                        class="grid grid-cols-1 sm:grid-cols-2 gap-5"
                        ></div>
                    <button
                        id="closeVoucherModal"
                        class="absolute top-3 right-3 px-3 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm font-medium shadow transition"
                        >
                        Đóng
                    </button>
                </div>
            </div>

            <!-- ================== JS ================== -->
            <script>
                // --------- SLOT DATA ---------
                const slotData = {
                    slots: [
                        {slot: 1, time: "8:00 - 10:00", left: 50},
                        {slot: 2, time: "10:00 - 12:00", left: 50},
                        {slot: 3, time: "12:00 - 14:00", left: 50},
                        {slot: 4, time: "14:00 - 16:00", left: 50},
                        {slot: 5, time: "16:00 - 18:00", left: 50},
                        {slot: 6, time: "18:00 - 20:00", left: 50},
                    ],
                };

                // Hiển thị modal
                const slotBtn = document.getElementById("slotBtn");
                const slotModal = document.getElementById("slotModal");
                const slotModalContent = document.getElementById("slotModalContent");
                const closeSlotModal = document.getElementById("closeSlotModal");

                // Các phần tử cần cập nhật
                const calendarMonthLabel =
                        document.getElementById("calendarMonthLabel");
                const calendarGrid = document.getElementById("calendarGrid");
                const slotDayLabel = document.getElementById("slotDayLabel");
                const slotList = document.getElementById("slotList");
                const prevMonthBtn = document.getElementById("prevMonthBtn");
                const nextMonthBtn = document.getElementById("nextMonthBtn");
                const selectedDateText = document.getElementById("selectedDateText");
                const selectedTimeText = document.getElementById("selectedTimeText");
                const slotNumberText = document.getElementById("slotNumberText");

                let today = new Date();
                let calendarMonth = today.getMonth();
                let calendarYear = today.getFullYear();
                let selectedDate = new Date(
                        today.getFullYear(),
                        today.getMonth(),
                        today.getDate()
                        );
                let selectedSlot = slotData.slots[4]; // Mặc định slot 5

                function renderCalendar(y, m) {
                    const monthNames = [
                        "January",
                        "February",
                        "March",
                        "April",
                        "May",
                        "June",
                        "July",
                        "August",
                        "September",
                        "October",
                        "November",
                        "December",
                    ];
                    calendarMonthLabel.textContent = `${monthNames[m].toUpperCase()} ${y}`;
                    const firstDay = new Date(y, m, 1);
                    const startDay = firstDay.getDay();
                    const daysInMonth = new Date(y, m + 1, 0).getDate();
                    calendarGrid.innerHTML = "";
                    let grid = [];
                    let blanks = startDay === 0 ? 6 : startDay - 1;
                    for (let i = 0; i < blanks; i++)
                        grid.push("");
                    for (let d = 1; d <= daysInMonth; d++)
                        grid.push(d);
                    while (grid.length % 7 !== 0)
                        grid.push("");
                    for (let i = 0; i < grid.length; i++) {
                        let d = grid[i];
                        let cell = document.createElement("div");
                        cell.className =
                                "calendar-day text-gray-700 text-base py-2 cursor-pointer transition";
                        if (d === "") {
                            cell.className += " disabled";
                            cell.innerHTML = "&nbsp;";
                        } else {
                            let thisDate = new Date(y, m, d);
                            cell.textContent = d;
                            if (
                                    thisDate.getFullYear() === today.getFullYear() &&
                                    thisDate.getMonth() === today.getMonth() &&
                                    thisDate.getDate() === today.getDate()
                                    )
                                cell.className += " today";
                            if (
                                    thisDate.getFullYear() === selectedDate.getFullYear() &&
                                    thisDate.getMonth() === selectedDate.getMonth() &&
                                    thisDate.getDate() === selectedDate.getDate()
                                    )
                                cell.className += " selected";
                            cell.onclick = () => {
                                selectedDate = new Date(y, m, d);
                                renderCalendar(y, m);
                                renderSlots();
                            };
                        }
                        calendarGrid.appendChild(cell);
                    }
                }
                function renderSlots() {
                    const weekday = [
                        "Chủ nhật",
                        "Thứ 2",
                        "Thứ 3",
                        "Thứ 4",
                        "Thứ 5",
                        "Thứ 6",
                        "Thứ 7",
                    ];
                    const label = `${weekday[selectedDate.getDay()]}, ${selectedDate
                            .getDate()
                            .toString()
                            .padStart(2, "0")}/${(selectedDate.getMonth() + 1)
                            .toString()
                            .padStart(2, "0")}/${selectedDate.getFullYear()}`;
                    slotDayLabel.textContent = label;
                    slotList.innerHTML = "";
                    slotData.slots.forEach((slot) => {
                        let slotDiv = document.createElement("button");
                        slotDiv.type = "button";
                        slotDiv.className =
                                "slot-item w-full border border-gray-300 rounded-lg px-5 py-3 flex flex-col text-left transition text-base bg-white hover:border-blue-400 hover:bg-blue-50 focus:outline-none";
                        if (selectedSlot && selectedSlot.slot === slot.slot)
                            slotDiv.className += " selected border-blue-600 bg-blue-50";
                        slotDiv.innerHTML = `<div class="flex justify-between items-center mb-1">
                <span class="font-semibold text-base text-blue-700">Slot ${slot.slot}</span>
                <span class="text-gray-600 text-sm">${slot.time}</span>
              </div>
              <div class="text-xs text-gray-400 ml-1">Đang còn: ${slot.left}</div>`;
                        slotDiv.onclick = () => {
                            selectedSlot = slot;
                            renderSlots();
                            // Update thông tin lên box trái
                            selectedDateText.textContent =
                                    selectedDate.toLocaleDateString("vi-VN");
                            selectedTimeText.textContent = selectedSlot.time;
                            slotNumberText.textContent = selectedSlot.slot;
                            slotModal.classList.add("hidden");
                        };
                        slotList.appendChild(slotDiv);
                    });
                }
                // Sự kiện modal và cập nhật lên box chính
                if (slotBtn && slotModal && closeSlotModal) {
                    slotBtn.onclick = () => {
                        slotModal.classList.remove("hidden");
                        renderCalendar(calendarYear, calendarMonth);
                        renderSlots();
                    };
                    closeSlotModal.onclick = () => {
                        slotModal.classList.add("hidden");
                        selectedDateText.textContent =
                                selectedDate.toLocaleDateString("vi-VN");
                        selectedTimeText.textContent = selectedSlot.time;
                        slotNumberText.textContent = selectedSlot.slot;
                    };
                    slotModal.onclick = (e) => {
                        if (e.target === slotModal) {
                            slotModal.classList.add("hidden");
                            selectedDateText.textContent =
                                    selectedDate.toLocaleDateString("vi-VN");
                            selectedTimeText.textContent = selectedSlot.time;
                            slotNumberText.textContent = selectedSlot.slot;
                        }
                    };
                }
                if (prevMonthBtn && nextMonthBtn) {
                    prevMonthBtn.onclick = () => {
                        calendarMonth--;
                        if (calendarMonth < 0) {
                            calendarMonth = 11;
                            calendarYear--;
                        }
                        renderCalendar(calendarYear, calendarMonth);
                    };
                    nextMonthBtn.onclick = () => {
                        calendarMonth++;
                        if (calendarMonth > 11) {
                            calendarMonth = 0;
                            calendarYear++;
                        }
                        renderCalendar(calendarYear, calendarMonth);
                    };
                }
            </script>
            <script>
                // --------- Vé ---------
                const ticketTypes = [
                    {
                        name: "Vé người lớn",
                        price: 50000,
                        description:
                                "Dành cho người từ 18 tuổi trở lên. Không giới hạn số lượt vào trong ngày.",
                    },
                    {
                        name: "Vé trẻ con",
                        price: 50000,
                        description:
                                "Dành cho trẻ em dưới 12 tuổi. Trẻ em cần có người lớn đi kèm.",
                    },
                    {
                        name: "Vé người già",
                        price: 50000,
                        description:
                                "Dành cho khách hàng từ 60 tuổi trở lên. Vui lòng xuất trình giấy tờ khi vào cổng.",
                    },
                    {
                        name: "Vé tháng",
                        price: 50000,
                        description:
                                "Sử dụng không giới hạn số lần trong vòng 30 ngày kể từ ngày mua vé.",
                    },
                    {
                        name: "Vé tuần",
                        price: 50000,
                        description:
                                "Sử dụng không giới hạn số lần trong vòng 7 ngày kể từ ngày mua vé.",
                    },
                ];
                let selectedTickets = [
                    {name: "Vé người lớn", price: 50000, quantity: 1},
                    {name: "Vé trẻ con", price: 50000, quantity: 1},
                ];

                const addTicketBtn = document.getElementById("addTicketBtn");
                const ticketModal = document.getElementById("ticketModal");
                const closeTicketModal = document.getElementById("closeTicketModal");
                const ticketListArea = document.getElementById("ticketListArea");
                const selectedTicketsArea = document.getElementById(
                        "selectedTicketsArea"
                        );

                function renderSelectedTickets() {
                    selectedTicketsArea.innerHTML = "";
                    selectedTickets.forEach((ticket, idx) => {
                        const otherSelectedNames = selectedTickets
                                .filter((t, i) => i !== idx)
                                .map((t) => t.name);
                        const selectWrap = document.createElement("div");
                        selectWrap.className = "relative flex-1";
                        const select = document.createElement("select");
                        select.className = "border rounded-md p-2 w-full min-w-[140px]";
                        ticketTypes.forEach((type) => {
                            const option = document.createElement("option");
                            option.value = type.name;
                            option.textContent = type.name;
                            option.disabled = otherSelectedNames.includes(type.name);
                            if (type.name === ticket.name)
                                option.selected = true;
                            select.appendChild(option);
                        });
                        select.title =
                                ticketTypes.find((t) => t.name === ticket.name)?.description ||
                                "";
                        select.onchange = function () {
                            const t = ticketTypes.find((t) => t.name === select.value);
                            ticket.name = t.name;
                            ticket.price = t.price;
                            renderSelectedTickets();
                            updatePaymentDetail();
                        };
                        selectWrap.appendChild(select);

                        const minusBtn = document.createElement("button");
                        minusBtn.type = "button";
                        minusBtn.textContent = "-";
                        minusBtn.className =
                                "w-9 h-9 text-lg font-bold text-gray-700 hover:bg-gray-100 rounded-l transition";
                        minusBtn.onclick = function () {
                            if (ticket.quantity > 1) {
                                ticket.quantity--;
                                renderSelectedTickets();
                                updatePaymentDetail();
                            }
                        };
                        const plusBtn = document.createElement("button");
                        plusBtn.type = "button";
                        plusBtn.textContent = "+";
                        plusBtn.className =
                                "w-9 h-9 text-lg font-bold text-gray-700 hover:bg-gray-100 rounded-r transition";
                        plusBtn.onclick = function () {
                            ticket.quantity++;
                            renderSelectedTickets();
                            updatePaymentDetail();
                        };

                        const qtySpan = document.createElement("span");
                        qtySpan.className = "px-3 font-semibold";
                        qtySpan.textContent = ticket.quantity;

                        const qtyBox = document.createElement("div");
                        qtyBox.className =
                                "flex items-center gap-0 border border-gray-300 rounded-md ml-3";
                        qtyBox.appendChild(minusBtn);
                        qtyBox.appendChild(qtySpan);
                        qtyBox.appendChild(plusBtn);

                        const removeBtn = document.createElement("button");
                        removeBtn.type = "button";
                        removeBtn.className =
                                "ml-2 text-gray-400 hover:text-red-500 text-lg font-bold px-2";
                        removeBtn.title = "Xoá vé này";
                        removeBtn.innerHTML = "&times;";
                        removeBtn.onclick = function () {
                            selectedTickets.splice(idx, 1);
                            renderSelectedTickets();
                            updatePaymentDetail();
                        };

                        const row = document.createElement("div");
                        row.className = "flex items-center gap-2 mb-2";
                        row.appendChild(selectWrap);
                        row.appendChild(qtyBox);
                        row.appendChild(removeBtn);

                        selectedTicketsArea.appendChild(row);
                    });
                    updatePaymentDetail();
                }

                addTicketBtn.onclick = () => {
                    ticketModal.classList.remove("hidden");
                    renderTicketList();
                };
                closeTicketModal.onclick = () => ticketModal.classList.add("hidden");
                ticketModal.onclick = (e) => {
                    if (e.target === ticketModal)
                        ticketModal.classList.add("hidden");
                };

                function renderTicketList() {
                    ticketListArea.innerHTML = "";
                    ticketTypes.forEach((ticket, idx) => {
                        const isSelected = selectedTickets.some(
                                (t) => t.name === ticket.name
                        );
                        const box = document.createElement("div");
                        box.className = "border border-gray-400 rounded-md bg-white";
                        box.style.opacity = isSelected ? "0.5" : "1";
                        box.style.pointerEvents = isSelected ? "none" : "auto";
                        const header = document.createElement("div");
                        header.className =
                                "flex items-center justify-between px-3 pt-3 pb-1 cursor-pointer";
                        header.innerHTML = `
                    <span class="font-medium">${ticket.name}</span>
                    <span class="font-semibold">${ticket.price.toLocaleString(
                                "vi-VN"
                                )}đ</span>
                  `;
                        const arrowWrap = document.createElement("div");
                        arrowWrap.className =
                                "w-full border-t border-gray-300 flex justify-center items-center cursor-pointer hover:bg-gray-50 transition";
                        arrowWrap.innerHTML = `
                    <svg class="w-6 h-6 text-gray-500 transition-transform duration-200" style="transform: rotate(0deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  `;
                        const dropdown = document.createElement("div");
                        dropdown.className = "px-3 pb-3 pt-2 text-gray-600 text-sm hidden";
                        dropdown.textContent = ticket.description;
                        arrowWrap.onclick = function (e) {
                            e.stopPropagation();
                            const isOpen = !dropdown.classList.contains("hidden");
                            Array.from(ticketListArea.children).forEach((child) => {
                                if (child !== box) {
                                    child
                                            .querySelector(".ticket-dropdown")
                                            ?.classList.add("hidden");
                                    child
                                            .querySelector("svg")
                                            ?.style.setProperty("transform", "rotate(0deg)");
                                }
                            });
                            if (isOpen) {
                                dropdown.classList.add("hidden");
                                arrowWrap.querySelector("svg").style.transform = "rotate(0deg)";
                            } else {
                                dropdown.classList.remove("hidden");
                                arrowWrap.querySelector("svg").style.transform =
                                        "rotate(180deg)";
                            }
                        };
                        dropdown.classList.add("ticket-dropdown");
                        header.onclick = function () {
                            if (!isSelected) {
                                selectedTickets.push({
                                    name: ticket.name,
                                    price: ticket.price,
                                    quantity: 1,
                                });
                                renderSelectedTickets();
                                ticketModal.classList.add("hidden");
                            }
                        };
                        box.appendChild(header);
                        box.appendChild(arrowWrap);
                        box.appendChild(dropdown);
                        ticketListArea.appendChild(box);
                    });
                }

                // --------- Đồ thuê ---------
                const rentTypes = [
                    {
                        name: "Phao bơi",
                        price: 20000,
                        description: "Phao bơi tròn cho trẻ em hoặc người lớn.",
                    },
                    {
                        name: "Kính bơi",
                        price: 15000,
                        description: "Kính chống nước, phù hợp mọi lứa tuổi.",
                    },
                    {
                        name: "Đồ bơi nam",
                        price: 30000,
                        description: "Bộ đồ bơi cho nam, đa dạng kích cỡ.",
                    },
                    {
                        name: "Đồ bơi nữ",
                        price: 30000,
                        description: "Bộ đồ bơi cho nữ, nhiều mẫu mã.",
                    },
                    {
                        name: "Khăn tắm",
                        price: 10000,
                        description: "Khăn tắm mềm mại, hút nước tốt.",
                    },
                ];
                let selectedRents = [];

                const addRentBtn = document.getElementById("addRentBtn");
                const rentModal = document.getElementById("rentModal");
                const closeRentModal = document.getElementById("closeRentModal");
                const rentListArea = document.getElementById("rentListArea");
                const selectedRentsArea = document.getElementById("selectedRentsArea");

                function renderSelectedRents() {
                    selectedRentsArea.innerHTML = "";
                    selectedRents.forEach((rent, idx) => {
                        const otherSelectedNames = selectedRents
                                .filter((t, i) => i !== idx)
                                .map((t) => t.name);
                        const selectWrap = document.createElement("div");
                        selectWrap.className = "relative flex-1";
                        const select = document.createElement("select");
                        select.className = "border rounded-md p-2 w-full min-w-[140px]";
                        rentTypes.forEach((type) => {
                            const option = document.createElement("option");
                            option.value = type.name;
                            option.textContent = type.name;
                            option.disabled = otherSelectedNames.includes(type.name);
                            if (type.name === rent.name)
                                option.selected = true;
                            select.appendChild(option);
                        });
                        select.title =
                                rentTypes.find((t) => t.name === rent.name)?.description || "";
                        select.onchange = function () {
                            const t = rentTypes.find((t) => t.name === select.value);
                            rent.name = t.name;
                            rent.price = t.price;
                            renderSelectedRents();
                            updatePaymentDetail();
                        };
                        selectWrap.appendChild(select);

                        const minusBtn = document.createElement("button");
                        minusBtn.type = "button";
                        minusBtn.textContent = "-";
                        minusBtn.className =
                                "w-9 h-9 text-lg font-bold text-gray-700 hover:bg-gray-100 rounded-l transition";
                        minusBtn.onclick = function () {
                            if (rent.quantity > 1) {
                                rent.quantity--;
                                renderSelectedRents();
                                updatePaymentDetail();
                            }
                        };
                        const plusBtn = document.createElement("button");
                        plusBtn.type = "button";
                        plusBtn.textContent = "+";
                        plusBtn.className =
                                "w-9 h-9 text-lg font-bold text-gray-700 hover:bg-gray-100 rounded-r transition";
                        plusBtn.onclick = function () {
                            rent.quantity++;
                            renderSelectedRents();
                            updatePaymentDetail();
                        };

                        const qtySpan = document.createElement("span");
                        qtySpan.className = "px-3 font-semibold";
                        qtySpan.textContent = rent.quantity;

                        const qtyBox = document.createElement("div");
                        qtyBox.className =
                                "flex items-center gap-0 border border-gray-300 rounded-md ml-3";
                        qtyBox.appendChild(minusBtn);
                        qtyBox.appendChild(qtySpan);
                        qtyBox.appendChild(plusBtn);

                        const removeBtn = document.createElement("button");
                        removeBtn.type = "button";
                        removeBtn.className =
                                "ml-2 text-gray-400 hover:text-red-500 text-lg font-bold px-2";
                        removeBtn.title = "Xoá đồ này";
                        removeBtn.innerHTML = "&times;";
                        removeBtn.onclick = function () {
                            selectedRents.splice(idx, 1);
                            renderSelectedRents();
                            updatePaymentDetail();
                        };

                        const row = document.createElement("div");
                        row.className = "flex items-center gap-2 mb-2";
                        row.appendChild(selectWrap);
                        row.appendChild(qtyBox);
                        row.appendChild(removeBtn);

                        selectedRentsArea.appendChild(row);
                    });
                    updatePaymentDetail();
                }

                addRentBtn.onclick = () => {
                    rentModal.classList.remove("hidden");
                    renderRentList();
                };
                closeRentModal.onclick = () => rentModal.classList.add("hidden");
                rentModal.onclick = (e) => {
                    if (e.target === rentModal)
                        rentModal.classList.add("hidden");
                };

                function renderRentList() {
                    rentListArea.innerHTML = "";
                    rentTypes.forEach((rent, idx) => {
                        const isSelected = selectedRents.some((t) => t.name === rent.name);
                        const box = document.createElement("div");
                        box.className = "border border-gray-400 rounded-md bg-white";
                        box.style.opacity = isSelected ? "0.5" : "1";
                        box.style.pointerEvents = isSelected ? "none" : "auto";
                        const header = document.createElement("div");
                        header.className =
                                "flex items-center justify-between px-3 pt-3 pb-1 cursor-pointer";
                        header.innerHTML = `
                    <span class="font-medium">${rent.name}</span>
                    <span class="font-semibold">${rent.price.toLocaleString(
                                "vi-VN"
                                )}đ</span>
                  `;
                        const arrowWrap = document.createElement("div");
                        arrowWrap.className =
                                "w-full border-t border-gray-300 flex justify-center items-center cursor-pointer hover:bg-gray-50 transition";
                        arrowWrap.innerHTML = `
                    <svg class="w-6 h-6 text-gray-500 transition-transform duration-200" style="transform: rotate(0deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  `;
                        const dropdown = document.createElement("div");
                        dropdown.className = "px-3 pb-3 pt-2 text-gray-600 text-sm hidden";
                        dropdown.textContent = rent.description;
                        arrowWrap.onclick = function (e) {
                            e.stopPropagation();
                            const isOpen = !dropdown.classList.contains("hidden");
                            Array.from(rentListArea.children).forEach((child) => {
                                if (child !== box) {
                                    child
                                            .querySelector(".ticket-dropdown")
                                            ?.classList.add("hidden");
                                    child
                                            .querySelector("svg")
                                            ?.style.setProperty("transform", "rotate(0deg)");
                                }
                            });
                            if (isOpen) {
                                dropdown.classList.add("hidden");
                                arrowWrap.querySelector("svg").style.transform = "rotate(0deg)";
                            } else {
                                dropdown.classList.remove("hidden");
                                arrowWrap.querySelector("svg").style.transform =
                                        "rotate(180deg)";
                            }
                        };
                        dropdown.classList.add("ticket-dropdown");
                        header.onclick = function () {
                            if (!isSelected) {
                                selectedRents.push({
                                    name: rent.name,
                                    price: rent.price,
                                    quantity: 1,
                                });
                                renderSelectedRents();
                                rentModal.classList.add("hidden");
                            }
                        };
                        box.appendChild(header);
                        box.appendChild(arrowWrap);
                        box.appendChild(dropdown);
                        rentListArea.appendChild(box);
                    });
                }

                // --------- Voucher ---------
                const voucherTypes = [
                    {
                        code: "#VOUCHER20",
                        info: "Giảm 20% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail:
                                "Giảm 20% tổng hóa đơn cho tất cả khách hàng. Không áp dụng cùng các mã khác.",
                    },
                    {
                        code: "#VOUCHER21",
                        info: "Giảm 20% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail: "Giảm 20% tổng hóa đơn cho đơn hàng tiếp theo.",
                    },
                    {
                        code: "#FREESHIP",
                        info: "Giảm 20% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail: "Freeship toàn quốc cho đơn từ 100k.",
                    },
                    {
                        code: "#VOUCHERVV",
                        info: "Giảm 20% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail: "Giảm 20% cho đơn đặt vé ngoài giờ cao điểm.",
                    },
                    {
                        code: "#WELCOME",
                        info: "Giảm 10% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail: "Giảm 10% tổng hóa đơn cho khách lần đầu đặt vé.",
                    },
                    {
                        code: "#SUMMER25",
                        info: "Giảm 10% toàn bộ đơn",
                        expire: "2025-05-01",
                        used: "51%",
                        detail: "Giảm 10% tất cả đơn đặt vé trong tháng 5.",
                    },
                ];
                let selectedVoucher = null;

                const chooseVoucherSpan = document.getElementById("chooseVoucherSpan");
                const voucherModal = document.getElementById("voucherModal");
                const closeVoucherModal = document.getElementById("closeVoucherModal");
                const voucherListArea = document.getElementById("voucherListArea");

                chooseVoucherSpan.onclick = () => {
                    voucherModal.classList.remove("hidden");
                    renderVoucherList();
                };
                closeVoucherModal.onclick = () => voucherModal.classList.add("hidden");
                voucherModal.onclick = (e) => {
                    if (e.target === voucherModal)
                        voucherModal.classList.add("hidden");
                };

                function renderVoucherList() {
                    voucherListArea.innerHTML = "";
                    voucherTypes.forEach((voucher) => {
                        const box = document.createElement("div");
                        box.className =
                                "border border-gray-400 rounded-lg bg-white flex flex-row min-h-[84px] hover:border-blue-500 hover:shadow-md group transition relative cursor-pointer";
                        box.onclick = function () {
                            selectedVoucher = voucher;
                            chooseVoucherSpan.textContent = voucher.code;
                            chooseVoucherSpan.classList.add(
                                    "bg-green-50",
                                    "text-green-700",
                                    "border-green-200"
                                    );
                            chooseVoucherSpan.classList.remove(
                                    "bg-blue-50",
                                    "text-blue-700",
                                    "border-blue-200"
                                    );
                            voucherModal.classList.add("hidden");
                            updatePaymentDetail();
                        };
                        box.innerHTML = `
                    <div class="flex flex-col justify-between w-3/7 px-4 py-3">
                      <div class="font-semibold text-base text-gray-700 break-words">${voucher.code}</div>
                    </div>
                    <div class="flex-1 flex flex-col justify-between px-2 py-2">
                      <div class="font-semibold text-gray-800 mb-1">${voucher.info}</div>
                      <div class="text-xs text-gray-500">Hết hạn: ${voucher.expire}</div>
                      <div class="text-xs text-gray-500">Đã dùng: ${voucher.used}</div>
                    </div>
                  `;
                        voucherListArea.appendChild(box);
                    });
                }

                chooseVoucherSpan.oncontextmenu = function (e) {
                    e.preventDefault();
                    if (selectedVoucher !== null) {
                        selectedVoucher = null;
                        chooseVoucherSpan.textContent = "Chọn ưu đãi";
                        chooseVoucherSpan.classList.remove(
                                "bg-green-50",
                                "text-green-700",
                                "border-green-200"
                                );
                        chooseVoucherSpan.classList.add(
                                "bg-blue-50",
                                "text-blue-700",
                                "border-blue-200"
                                );
                        updatePaymentDetail();
                    }
                };

                // --------- Update Payment Detail ---------
                function calcVoucherDiscount(total) {
                    if (!selectedVoucher || !selectedVoucher.code)
                        return 0;
                    if (
                            selectedVoucher.code === "#VOUCHER20" ||
                            selectedVoucher.code === "#VOUCHER21" ||
                            selectedVoucher.code === "#VOUCHERVV"
                            ) {
                        return Math.round(total * 0.2);
                    }
                    if (
                            selectedVoucher.code === "#WELCOME" ||
                            selectedVoucher.code === "#SUMMER25"
                            ) {
                        return Math.round(total * 0.1);
                    }
                    // #FREESHIP, v.v. không giảm tiền, chỉ tặng quà
                    return 0;
                }

                function updatePaymentDetail() {
                    const paymentDetailArea =
                            document.getElementById("paymentDetailArea");
                    if (!paymentDetailArea)
                        return;

                    let html = "";
                    let total = 0;
                    selectedTickets.forEach((ticket) => {
                        if (ticket.quantity && ticket.quantity > 0) {
                            html += `
                      <div class="flex justify-between text-gray-700 text-sm mb-1">
                        <span>${ticket.name} <span class="text-gray-400">x${
                                    ticket.quantity
                                    }</span></span>
                        <span>${ticket.price.toLocaleString("vi-VN")} đ</span>
                      </div>
                    `;
                            total += ticket.price * ticket.quantity;
                        }
                    });
                    selectedRents.forEach((rent) => {
                        if (rent.quantity && rent.quantity > 0) {
                            html += `
                      <div class="flex justify-between text-gray-700 text-sm mb-1">
                        <span>${rent.name} <span class="text-gray-400">x${
                                    rent.quantity
                                    }</span></span>
                        <span>${rent.price.toLocaleString("vi-VN")} đ</span>
                      </div>
                    `;
                            total += rent.price * rent.quantity;
                        }
                    });

                    const discount = calcVoucherDiscount(total);
                    if (discount > 0) {
                        html += `
                    <div class="flex justify-between text-green-600 text-sm mb-1 font-semibold">
                      <span>Voucher (${selectedVoucher.code})</span>
                      <span>- ${discount.toLocaleString("vi-VN")} đ</span>
                    </div>
                  `;
                    }
                    const totalFinal = total - discount;
                    html += `<div class="border-b my-2"></div>
                  <div class="flex justify-between items-center font-bold text-lg mb-3">
                    <span>Tổng</span>
                    <span class="text-blue-700 text-2xl">${totalFinal.toLocaleString(
                            "vi-VN"
                            )} đ</span>
                  </div>`;
                    paymentDetailArea.innerHTML = html;
                }

                // --------- Render lần đầu ---------
                renderSelectedTickets();
                renderSelectedRents();
                updatePaymentDetail();
            </script>
        </div>
    </body>
</html>
